---
const { id, viewBox = "0 0 400 400", width = "100%", height = "400" } = Astro.props;
---

<svg id={id} viewBox={viewBox} width={width} height={height}></svg>

<script>
    import { geometryDrawings } from '../scripts/pages/geometryPage';
    import { vectorsDrawings } from '../scripts/pages/vectorsPage';
    import { testDrawings } from '../scripts/pages/testPage';
    import { ensureSharedMarkerDefs } from '../scripts/core/SVGDrawing';

    // Declarar MathJax para evitar errores de TypeScript (se carga globalmente)
    declare const MathJax: any;

    const allDrawings = { ...geometryDrawings, ...vectorsDrawings, ...testDrawings };

    const initDrawings = async () => {
        console.log("VectorCanvas: Iniciando renderizado de gráficos...");
        // Asegurar que los marcadores (flechas) estén definidos
        ensureSharedMarkerDefs();

        // Si MathJax está cargado, esperamos a que esté listo para renderizar
        if (typeof MathJax !== 'undefined' && MathJax.startup) {
            try {
                await MathJax.startup.promise;
            } catch (e) {
                console.error("Error esperando a MathJax:", e);
            }
        }

        for (const [id, drawFunc] of Object.entries(allDrawings)) {
            const svg = document.getElementById(id) as Element | null;
            // Verificamos si existe, es función y si NO ha sido dibujado ya (para evitar duplicados)
            if (svg instanceof SVGElement && typeof drawFunc === 'function' && !svg.hasAttribute('data-drawn')) {
                try {
                    drawFunc(svg);
                    svg.setAttribute('data-drawn', 'true'); // Marcamos como dibujado
                    console.log(`✅ Gráfico ${id} dibujado.`);
                } catch (e) {
                    console.error(`❌ Error dibujando ${id}:`, e);
                }
            }
        }
    };

    // Ejecutar inmediatamente (los scripts module se ejecutan tras el parseo del HTML)
    initDrawings();
    
    // Soporte opcional por si activas View Transitions en el futuro
    document.addEventListener('astro:after-swap', initDrawings);
</script>
